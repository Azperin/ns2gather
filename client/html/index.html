<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NS2 Gather</title>
<link rel="icon" type="image/x-icon" href="/favicon.ico">
<link rel="stylesheet" href="style.css" />
</head>
<body id="gather" class="loading">
	<div class="loader">...loading</div>
	<input type="password" class="logged-hide login-token-input" />
	<button class="logged-only">LOGOUT</button>

	<div id="readyroom"></div>

	<script src="pako.js"></script>
	<script>
		const GATHER = new Proxy({
			gatherElement: document.getElementById('gather'),
			mySteamid: '',
			state: 'loading',
			readyroomElement: document.getElementById('readyroom'),
			readyroom: {},
		}, {
			set: (gatherObj, prop, val) => {
				const prevValue = gatherObj[prop];
				gatherObj[prop] = val;

				console.log(prop);
				if (prop === 'mySteamid') {
					gatherObj.gatherElement.classList.toggle('logged', !!val);
				};

				if (prop === 'state') {
					gatherObj.gatherElement.classList.toggle(prevValue, false);
					gatherObj.gatherElement.classList.toggle(val, true);
				};

				return true;
			},
		});

		const WEBSOCKET_ROUTES = {
			'auth': ({ steamid = '' }) => {
				GATHER.mySteamid = steamid;
				if (!steamid) {
					return localStorage.removeItem('gathertoken');
				};
			},
			'gather_get': ({ gather }) => {
				GATHER.state = gather.state;
				// someday readyroom also will be proxy
				Object.entries(gather.readyroom).forEach(([steamid, player]) => {
					GATHER.readyroom[steamid] = player;
				});
			},
		};

		const WEBSOCKET = new WebSocket(getWebsocketAddress());
		WEBSOCKET.onopen = (e) => {
			const localToken = localStorage.getItem('gathertoken') || '';
			if (localToken) {
				const [ steamid, token ] = localToken.split('@');
				WEBSOCKET.send(JSON.stringify({ method: 'auth', steamid: steamid, token: token }));
			};

			WEBSOCKET.send(JSON.stringify({ method: 'gather_get' }));
		};

		WEBSOCKET.onerror = (e) => {};
		WEBSOCKET.onclose = (e) => {};
		WEBSOCKET.onmessage = async ({ data }) => {
			if (data instanceof Blob) {
				data = await data.arrayBuffer();
				data = pako.ungzip(data, { to: 'string' });
			};

			data = JSON.parse(data);
			WEBSOCKET_ROUTES[data.method]?.(data);
		};

		document.querySelector('.login-token-input').addEventListener('input', ({ target }) => {
			if (GATHER.mySteamid) return;
			if (!target.value || target.value.length < 160 || target.value.length > 250) return;
			const [ steamid, token ] = target.value.trim().split('@'); 
			if (steamid && token) {
				WEBSOCKET.send(JSON.stringify({ method: 'auth', steamid: steamid, token: token }));
				localStorage.setItem('gathertoken', `${ steamid }@${ token }`);
			};

			// should notify user if token format is invalid
			target.value = '';

		});

		function getWebsocketAddress() {
			switch(location.protocol) {
				case('file:'): return "ws://localhost:3545";
				case('http:'): return `ws://${ location.hostname }:3545`;
				case('https:'): return `wss://${ location.hostname }:3545`;
				default: return 'dunno';
			};
		};
	</script>
</body>
</html>